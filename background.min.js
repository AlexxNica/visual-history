var colorThief=new ColorThief();var Node=function(a){this.parent=null;this.depth=0;this.max_depth=0;this.url=a;this.image_url=null;this.title=null;this.children=[];this.insert=function(b){var c=new Node(b);c.depth=this.depth+1;c.parent=this;this.children.push(c);return c};this.current=this};var tabs={};chrome.contextMenus.create({title:"Push link to tree in background",contexts:["link"],onclick:function(b,a){if(tabs[a.id]&&b.linkUrl){tabs[a.id].urls[b.linkUrl]=tabs[a.id].current.insert(b.linkUrl);tabs[a.id].max_depth=Math.max(tabs[a.id].max_depth,tabs[a.id].current.depth+1)}}});chrome.browserAction.onClicked.addListener(function(a){navigate(a.id,function(b){return"stay"})});chrome.runtime.onMessage.addListener(function(b,a){if(b.key=="ctrl"){exitNavigation(a.tab.id)}});chrome.commands.onCommand.addListener(function(b){var a;if(b=="move-up"){a=up}else{if(b=="move-down"){a=down}else{if(b=="move-left"){a=left}else{if(b=="move-right"){a=right}}}}chrome.tabs.query({active:true,windowType:"normal",currentWindow:true},function(c){navigate(c[0].id,a)})});chrome.tabs.onRemoved.addListener(function(b,a){delete tabs[b]});chrome.tabs.onReplaced.addListener(function(b,a){onNavigateTo(a,tabs[b].url);tabs[b]=tabs[a];delete tabs[a]});chrome.webNavigation.onCommitted.addListener(function(a){var b=a.transitionType;if(tabs[a.tabId]&&!tabs[a.tabId].override&&tabs[a.tabId].urls[a.url]){console.log("setting current to",a.url,tabs[a.tabId].urls[a.url].url);tabs[a.tabId].current=tabs[a.tabId].urls[a.url];tabs[a.tabId].current.processId=a.processId;return}else{if(tabs[a.tabId]&&a.transitionQualifiers.indexOf("client_redirect")>=0){tabs[a.tabId].current.url=a.url;tabs[a.tabId].current.processId=a.processId;tabs[a.tabId].urls[a.url]=tabs[a.tabId].current;return}else{switch(b){case"link":break;case"typed":break;case"auto_bookmark":break;case"auto_subframe":return;case"manual_subframe":break;case"generated":break;case"auto_toplevel":return;case"form_submit":return;case"reload":return;case"keyword":return;case"keyword_generated":return}}}if(tabs[a.tabId]){tabs[a.tabId].urls[a.url]=tabs[a.tabId].current}if(tabs[a.tabId]&&tabs[a.tabId].override){tabs[a.tabId].override=false}else{onNavigateTo(a.tabId,a.url,a.processId)}});chrome.webNavigation.onCompleted.addListener(function(a){if(tabs[a.tabId]){if(tabs[a.tabId].current.processId==a.processId){chrome.tabs.get(a.tabId,function(c){if(!chrome.runtime.lastError){var d=tabs[a.tabId].current;if(!d.icon_url){d.icon_url=c.favIconUrl}if(c.title){d.title=c.title}var b=new Image;b.onload=function(){d.img_color=colorThief.getColor(b)};b.src=c.favIconUrl}})}}});function onNavigateTo(b,a,d){var c;console.log("setting current to",a);if(tabs[b]){c=tabs[b].current.insert(a);c.processId=d;tabs[b].current=c;tabs[b].urls[a]=c;tabs[b].max_depth=Math.max(tabs[b].max_depth,c.depth)}else{c=new Node(a);c.current=c;c.processId=d;c.urls={};c.urls[a]=c;tabs[b]=c}}function takeScreenshot(a){chrome.tabs.captureVisibleTab(null,{format:"png"},function(b){if(b){a.image_url=b}})}function up(a){console.log("setting current to");if(tabs[a]&&tabs[a].current.parent){tabs[a].current=tabs[a].current.parent}return"up"}function down(a){console.log("setting current to");if(tabs[a]&&tabs[a].current.children.length>0){tabs[a].current=tabs[a].current.children[tabs[a].current.children.length-1]}return"down"}function left(b){console.log("setting current to");if(tabs[b]&&tabs[b].current.parent&&tabs[b].current.parent.children.length>1){var a=tabs[b].current.parent.children.indexOf(tabs[b].current);if(a>0){tabs[b].current=tabs[b].current.parent.children[a-1]}}return"left"}function right(b){console.log("setting current to");if(tabs[b]&&tabs[b].current.parent&&tabs[b].current.parent.children.length>1){var a=tabs[b].current.parent.children.indexOf(tabs[b].current);if(a>-1&&a<tabs[b].current.parent.children.length-1){tabs[b].current=tabs[b].current.parent.children[a+1]}}return"right"}function navigate(d,c){c=c(d);var b=getTree(tabs[d],tabs[d].current);var e=tabs[d].current.depth;var a=tabs[d].max_depth;chrome.tabs.sendMessage(d,{move:c,tree:b,depth_of_current:e,max_depth:a},function(){})}function getTree(c,d){if(!c.title){c.title=c.url.substr(0,30)+"... "}var a={name:c==c.title.length>40?c.title:c.title.substr(0,30)+"... ",url:c==c.url.length>40?c.url:c.url.substr(0,30)+"... ",full_url:c.url,image_url:c.image_url,icon_url:c.icon_url,img_color:c.img_color,current:c==d,children:[]};for(var b=0;b<c.children.length;b++){a.children.push(getTree(c.children[b],d))}return a}function exitNavigation(a){chrome.tabs.get(a,function(b){if(b.url!=tabs[b.id].current.url){tabs[b.id].override=true;chrome.tabs.update(b.id,{url:tabs[b.id].current.url})}})}function printTab(a){formatTab(tabs[a],2,tabs[a].current);console.log("")}function formatTab(c,a,f){var d,e;if(c==f){d="1";e=new Array(a-1).join(" ")}else{d="";e=new Array(a).join(" ")}console.log(d+e+c.url.substr(0,50));for(var b=0;b<c.children.length;b++){formatTab(c.children[b],a+4,f)}};