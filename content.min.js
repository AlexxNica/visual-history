var height_scale=180;var old_body_style="auto";var default_image=chrome.extension.getURL("tab.png");var NAV=false;var css=document.createElement("link");css.setAttribute("type","text/css");css.setAttribute("rel","stylesheet");css.setAttribute("href",chrome.extension.getURL("tree.css"));var head=document.head||document.getElementsByTagName("head")[0]||document.documentElement;head.insertBefore(css,head.firstChild);if(document.getElementById("install-histree-button")){document.getElementById("install-histree-button").innerHTML="View in Chrome Web Store"}var body=document.getElementsByTagName("body")[0];var d=makeDiv();function makeDiv(){d=document.createElement("div");d.setAttribute("id","histree");d.style.padding=0;d.style.margin=0;d.style.position="fixed";d.style.height=window.innerHeight;d.style.width=window.innerWidth;d.style.left=0;d.style.right=0;d.style.top=0;d.style.bottom=0;d.style.zIndex=-1;d.style.visibility="hidden";d.style.overflowY="hidden";d.style.overflowX="hidden";d.style.backgroundColor="rgba(255, 255, 255, 0.8)";body.insertBefore(d,body.firstChild);return d}document.documentElement.onkeyup=function(a){if((a.keyCode=="17"||a.keyIdentifier=="Meta")&&NAV){chrome.runtime.sendMessage({key:"ctrl"},function(){});removeTree()}};chrome.runtime.onMessage.addListener(function(c,b,a){if(!NAV){if(c.move=="stay"){d.style.overflowY="scroll"}createTree(c.tree,c.depth_of_current,c.max_depth);NAV=true}else{if(c.move=="up"){up()}else{if(c.move=="down"){down()}else{if(c.move=="left"){left()}else{if(c.move=="right"){right()}else{removeTree()}}}}}});var i=0,duration=1,root;var tree,svg,currentNode;function createTree(f,g,c){root=f;root.x0=0;root.y0=0;old_body_style=body.style.overflowY;body.style.overflowY="hidden";d.style.zIndex=1000;d.style.visibility="visible";var b=height_scale*(c+1);tree=d3.layout.tree().size([window.innerWidth,b]);svg=d3.select("#histree").append("svg").attr("width",window.innerWidth).attr("height",b).attr("class","histree-animated histree-fadeIn").append("g").attr("transform","translate(0, 50)");var a=svg.append("defs");var e=a.append("filter").attr("id","f1").attr("x","0").attr("y","0").attr("width","500%").attr("height","500%");e.append("feOffset").attr("result","offOut").attr("in","SourceAlpha").attr("dx","0").attr("dy","0");e.append("feGaussianBlur").attr("result","blurOut").attr("in","offOut").attr("stdDeviation","3");e.append("feBlend").attr("in","SourceGraphic").attr("in2","blurOut").attr("mode","normal");currentNode=findCurrent(root);update(root);d.scrollTop=(g*height_scale)-(window.innerHeight/2)}function findCurrent(b){if(b.current){return b}if(b.children){for(var a=0;a<b.children.length;a++){var c=findCurrent(b.children[a]);if(c!=false){return c}}}return false}function removeTree(){document.getElementsByTagName("body")[0].style.overflowY=old_body_style;if(svg){svg.remove()}d.parentElement.removeChild(d);d=null;makeDiv();NAV=false;svg=null;tree=null}function update(a){var c=tree.nodes(root).reverse(),l=tree.links(c);c.forEach(function(m){m.y=m.depth*height_scale});var e=svg.selectAll("g.histree-node").data(c,function(m){return m.id||(m.id=++i)});var g=e.enter().append("g").attr("class","histree-node").attr("transform",function(){return"translate("+a.y0+","+a.x0+")"}).on("click",click);g.append("image").attr("x","-50px").attr("y","-50px").attr("width","100px").attr("height","100px").attr("xlink:href",function(m){if(m.current&&m.image_url){return m.image_url}if(m.icon_url){return m.icon_url}return default_image});g.append("text").attr("x",0).attr("dy","4.5em").attr("text-anchor","middle").text(function(m){return m.name}).style("fill-opacity",0.000001).style("font-weight","bold");g.append("text").attr("x",0).attr("dy","5.5em").attr("text-anchor","middle").text(function(m){return m.url});var h=e.transition().duration(0).attr("transform",function(m){return"translate("+m.x+","+m.y+")"});for(i=0;i<e[0].length;i++){if(d3.select(e[0][i]).datum().current){var f=rgbToHex(64,128,192);var b=d3.select(e[0][i]).datum().img_color;if(b){f=rgbToHex(b[0],b[1],b[2])}d.scrollTop=d3.select(e[0][i]).datum().y0-(window.innerHeight/2);d3.select(e[0][i]).select("text").attr("fill",f).attr("class","histree-shadow");d3.select(e[0][i]).select("image").attr("filter","url(#f1)").attr("xlink:href",function(m){if(m.image_url){return m.image_url}if(m.icon_url){return m.icon_url}return default_image})}else{d3.select(e[0][i]).select("text").attr("fill","black").attr("class","histree-no-shadow");d3.select(e[0][i]).select("image").attr("filter",null).attr("xlink:href",function(m){return m.icon_url?m.icon_url:default_image})}}h.select("text").style("fill-opacity",1);var k=e.exit().transition().duration(duration).attr("transform",function(m){return"translate("+a.y+","+a.x+")"}).remove();k.select("text").style("fill-opacity",0.000001);var j=svg.selectAll("path.link").data(l,function(m){return m.target.id});j.enter().append("line").attr("class","histree-link").attr("x1",function(m){return m.source.x}).attr("y1",function(m){return m.source.y+75}).attr("x2",function(m){return m.target.x}).attr("y2",function(m){return m.target.y-40});c.forEach(function(m){m.x0=m.x;m.y0=m.y})}function up(){if(currentNode.parent){currentNode.current=false;currentNode=currentNode.parent;currentNode.current=true;update(svg)}}function down(){if(currentNode.children){currentNode.current=false;var a=currentNode.children.length-1;currentNode=currentNode.children[a];currentNode.current=true;update(svg)}}function left(){if(currentNode.parent){var b=currentNode.parent.children;var a=b.indexOf(currentNode);if(a!=0){currentNode.current=false;currentNode=b[a-1];currentNode.current=true;update(svg)}}}function right(){if(currentNode.parent){var b=currentNode.parent.children;var a=b.indexOf(currentNode);if(a!=b.length-1){currentNode.current=false;currentNode=b[a+1];currentNode.current=true;update(svg)}}}function componentToHex(b){var a=b.toString(16);return a.length==1?"0"+a:a}function rgbToHex(e,c,a){if(e+c+a<32*3){e=256-e;a=256-a;c=256-c}return"#"+componentToHex(e)+componentToHex(c)+componentToHex(a)}function click(a){if(!a){return}if(a.current){removeTree()}else{a.current=true;currentNode=a;if(a.full_url){location.href=a.full_url}else{chrome.runtime.sendMessage({key:"ctrl"},function(){});removeTree()}}};